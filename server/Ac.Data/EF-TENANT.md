# Миграции TenantDb (схемы тенантов)

В каждой схеме тенанта (`t_<Inn>`) хранится своя история миграций в таблице `__EFMigrationsHistory`. Миграции генерируются один раз для шаблонной схемы `tenant_template`, затем раннер применяет их ко всем схемам из `public.Tenants`.

---

## 1. Создание миграции TenantDb

Из корня репозитория, **из каталога стартап-проекта (Ac.Api)** — чтобы подхватился `appsettings.json` с connection string:

```bash
cd server/Ac.Api
dotnet ef migrations add <ИмяМиграции> --context TenantDb --project ../Ac.Data
```

Пример:

```bash
cd server/Ac.Api
dotnet ef migrations add InitialTenantSchema --context TenantDb --project ../Ac.Data
```

Будет создана новая папка/файлы в `Ac.Data/Migrations/` с суффиксом для TenantDb (и отдельный снимок модели `*TenantDb*`, если EF создаст его отдельно). Имя миграции — на ваше усмотрение (например `InitialTenantSchema`, `AddButtonSettings` и т.д.).

- **Важно:** указывайте `--context TenantDb`, чтобы не затронуть миграции ApiDb.
- Схема в сгенерированном коде будет `tenant_template` — это нормально; раннер подставит реальные схемы при применении.

---

## 2. Применение миграций

**Через админку:** страница «Миграции тенантов» → кнопка «Применить миграции ко всем схемам».

**Через аргумент (CI/CD):**

```bash
cd server/Ac.Admin
dotnet run -- migrate_tenants
```

Конфигурация берётся из appsettings.json. В каждой схеме тенанта создаётся `CREATE SCHEMA IF NOT EXISTS`, затем применяются ожидающие миграции TenantDb; в каждой схеме своя `__EFMigrationsHistory`.

---

## 3. Добавление нового тенанта

1. Добавить запись в `public.Tenants` (в т.ч. поле `Inn`).
2. Запустить раннер: он создаст схему `t_<Inn>` и применит к ней все текущие миграции TenantDb.

Отдельно создавать схему вручную не обязательно — раннер выполняет `CREATE SCHEMA IF NOT EXISTS` перед применением миграций.

---

## 4. Консистентность при сбое

- История миграций **отдельная в каждой схеме**.
- Если при применении миграции одна из схем упадёт, остальные уже могут быть обновлены. Нужно:
  - устранить причину ошибки (данные, права, сеть);
  - снова запустить раннер — он применит ожидающие миграции только к отстающим схемам.

Откат (revert) миграции по всем схемам в автоматическом режиме не предусмотрен — при необходимости откатывать вручную по каждой схеме (обратные скрипты или `dotnet ef database update <ПредыдущаяМиграция> --context TenantDb` с подстановкой схемы).
