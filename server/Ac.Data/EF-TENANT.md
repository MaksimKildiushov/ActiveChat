# Миграции TenantDb (каждому клиенту отдельная схема)
## Описание
У каждого тенанта идентичный набор таблиц, но в своей схеме с именем `t_<Inn>` и отдельной историей миграций в таблице `__EFMigrationsHistory`. Миграции генерируются для виртуальной схемы `tenant_template`, затем применяются ко всем Тенатам из `public.Tenants` — через страницу админки или при запуске Admin с аргументом `migrate_tenants`.

---

## ВАЖНО! Смена контекста (appsettings) для которых будут выполняться все (!) команды.

```bash
cd server/Ac.Api
export ASPNETCORE_ENVIRONMENT=Production
export ASPNETCORE_ENVIRONMENT=Development
```

```powershell
$env:ASPNETCORE_ENVIRONMENT='Production'
$env:ASPNETCORE_ENVIRONMENT='Development'
```

---

## 1. Создание миграции TenantDb

```bash
cd server/Ac.Api
dotnet ef migrations add RemoveCreatedAt --context TenantDb --project ../Ac.Data
```

```powershell
Add-Migration AddConversationFields -o Migrations/Tenant -Context TenantDb -Project Ac.Data -StartupProject Ac.Api
```

---

## 2. Применение миграций

### Через админку (рекомендуется)

1. Запустите Admin, войдите под учёткой с ролью Admin.
2. Откройте страницу **«Миграции тенантов»** (в меню).
3. Нажмите **«Применить миграции ко всем схемам»**.
4. Результат по каждой схеме отобразится в таблице.

Схемы берутся из `public.Tenants` (поле `Inn` → схема `t_<Inn>`). В каждой схеме создаётся `CREATE SCHEMA IF NOT EXISTS`, затем применяются ожидающие миграции TenantDb.

### Через аргумент при запуске (CI/CD)

Для скриптов деплоя или автоматизации можно запустить Admin с аргументом `migrate_tenants`: миграции выполнятся, результат выведется в консоль, приложение завершится с кодом 0 (успех) или 1 (есть ошибки по схемам).

**CLI:**

```bash
cd server/Ac.Admin
dotnet run -- migrate_tenants
```

**PMC (Visual Studio):** через PMC применить миграции по всем схемам тенантов нельзя — для этого используйте админку или CLI выше. В PMC можно только применить миграции к одному контексту БД (например, к основной БД): `Update-Database -Context TenantDb` — но это не заменит «применить ко всем схемам тенантов».

Конфигурация (connection string) берётся из `appsettings.json` и переменных окружения так же, как при обычном запуске Admin.

---

## 3. Добавление нового тенанта

1. Добавить запись в `public.Tenants` (в т.ч. поле `Inn`) — через админку «Тенанты» или API.
2. Применить миграции: открыть страницу «Миграции тенантов» в админке и нажать «Применить миграции ко всем схемам», либо выполнить `dotnet run -- migrate_tenants` из Ac.Admin.

Схема `t_<Inn>` создаётся при применении миграций (`CREATE SCHEMA IF NOT EXISTS`). Отдельно создавать её вручную не обязательно.

---

## 4. Консистентность при сбое

- История миграций **отдельная в каждой схеме**.
- Если при применении одна из схем упадёт, остальные уже могут быть обновлены. Нужно устранить причину ошибки и снова запустить применение (админка или `migrate_tenants`) — ожидающие миграции применятся только к отстающим схемам.

Откат (revert) миграции по всем схемам в автоматическом режиме не предусмотрен — при необходимости откатывать вручную по каждой схеме.
