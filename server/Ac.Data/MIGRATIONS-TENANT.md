# Миграции TenantDb (схемы тенантов)

В каждой схеме тенанта (`t_<Inn>`) хранится своя история миграций в таблице `__EFMigrationsHistory`. Миграции генерируются один раз для шаблонной схемы `tenant_template`, затем применяются ко всем схемам из `public.Tenants` — через страницу админки или при запуске Admin с аргументом `migrate_tenants`.

---

## Обязательный порядок при изменении модели TenantDb

После **любого** изменения сущностей или конфигурации TenantDb (новые таблицы/колонки в Conversations, Messages, DecisionAudits и т.д.):

1. **Сначала** создайте миграцию: `dotnet ef migrations add <Имя> --context TenantDb --project ../Ac.Data` (из каталога Ac.Api).
2. Проверьте сгенерированную миграцию: если в ней есть изменения (не пустой `Up()`/`Down()`) — вы ничего не забыли.
3. **Затем** примените миграции ко всем схемам (страница «Миграции тенантов» или `dotnet run -- migrate_tenants`).

Если вы забыли шаг 1, приложение при работе с тенантом может упасть с ошибкой (например, отсутствующая колонка). При следующем `migrations add` EF сгенерирует одну большую миграцию со всеми пропущенными изменениями — тогда нужно будет применить её.

---

## 1. Создание миграции TenantDb

Из каталога стартап-проекта (Ac.Api), чтобы подхватился `appsettings.json` с connection string:

```bash
cd server/Ac.Api
dotnet ef migrations add Initial --context TenantDb --project ../Ac.Data
```

Пример:

```bash
cd server/Ac.Api
dotnet ef migrations add InitialTenantSchema --context TenantDb --project ../Ac.Data
```

Будет создана новая папка/файлы в `Ac.Data/Migrations/` для TenantDb. Имя миграции — на ваше усмотрение.

- **Важно:** указывайте `--context TenantDb`, чтобы не затронуть миграции ApiDb.
- Схема в сгенерированном коде будет `tenant_template` — это нормально; при применении используются реальные схемы тенантов.

---

## 2. Применение миграций

### Через админку (рекомендуется)

1. Запустите Admin, войдите под учёткой с ролью Admin.
2. Откройте страницу **«Миграции тенантов»** (в меню).
3. Нажмите **«Применить миграции ко всем схемам»**.
4. Результат по каждой схеме отобразится в таблице.

Схемы берутся из `public.Tenants` (поле `Inn` → схема `t_<Inn>`). В каждой схеме создаётся `CREATE SCHEMA IF NOT EXISTS`, затем применяются ожидающие миграции TenantDb.

### Через аргумент при запуске (CI/CD)

Для скриптов деплоя или автоматизации можно запустить Admin с аргументом `migrate_tenants`: миграции выполнятся, результат выведется в консоль, приложение завершится с кодом 0 (успех) или 1 (есть ошибки по схемам).

```bash
cd server/Ac.Admin
dotnet run -- migrate_tenants
```

Конфигурация (connection string) берётся из `appsettings.json` и переменных окружения так же, как при обычном запуске Admin.

---

## 3. Добавление нового тенанта

1. Добавить запись в `public.Tenants` (в т.ч. поле `Inn`) — через админку «Тенанты» или API.
2. Применить миграции: открыть страницу «Миграции тенантов» в админке и нажать «Применить миграции ко всем схемам», либо выполнить `dotnet run -- migrate_tenants` из Ac.Admin.

Схема `t_<Inn>` создаётся при применении миграций (`CREATE SCHEMA IF NOT EXISTS`). Отдельно создавать её вручную не обязательно.

---

## 4. Консистентность при сбое

- История миграций **отдельная в каждой схеме**.
- Если при применении одна из схем упадёт, остальные уже могут быть обновлены. Нужно устранить причину ошибки и снова запустить применение (админка или `migrate_tenants`) — ожидающие миграции применятся только к отстающим схемам.

Откат (revert) миграции по всем схемам в автоматическом режиме не предусмотрен — при необходимости откатывать вручную по каждой схеме.
